---
import BaseLayout from '../layouts/BaseLayout.astro';
import { getAllDepartements, getDefaultContact } from '../utils/departement-contact';
import departementsConfigRaw from '../data/departements-config.json';

const departements = getAllDepartements();
const defaultContact = getDefaultContact();

const title = "Administration - Eric Plomberie";
const description = "Interface d'administration pour g√©rer les contacts par d√©partement";
---

<BaseLayout title={title} description={description}>
  <div class="min-h-screen bg-gray-100 py-12 px-4">
    <div class="max-w-6xl mx-auto">
      <h1 class="text-4xl font-bold text-gray-900 mb-8">Administration Eric Plomberie</h1>

      <div id="login-form" class="bg-white rounded-lg shadow-md p-8 max-w-md mx-auto">
        <h2 class="text-2xl font-bold mb-6">Connexion</h2>

        <div id="error-message" class="hidden bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded mb-4">
          Mot de passe incorrect
        </div>

        <div class="space-y-4">
          <div>
            <label for="password" class="block text-sm font-medium text-gray-700 mb-2">
              Mot de passe
            </label>
            <input
              type="password"
              id="password"
              class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-primary-500"
              placeholder="Entrez le mot de passe"
            />
          </div>

          <button
            id="login-btn"
            class="w-full bg-primary-600 text-white px-6 py-3 rounded-lg font-semibold hover:bg-primary-700 transition"
          >
            Se connecter
          </button>
        </div>
      </div>

      <div id="admin-panel" class="hidden">
        <div class="bg-white rounded-lg shadow-md p-8">
          <div class="flex items-center justify-between mb-6">
            <h2 class="text-2xl font-bold">Gestion des contacts par d√©partement</h2>
            <div class="flex items-center gap-4">
              <div id="session-timer" class="text-sm text-gray-500">
                Session : <span id="session-time" class="font-semibold text-primary-600">10:00</span>
              </div>
              <button
                id="logout-btn"
                class="text-sm text-red-600 hover:text-red-700 font-semibold"
              >
                üö™ D√©connexion
              </button>
            </div>
          </div>

          <div id="success-message" class="hidden bg-green-100 border border-green-400 text-green-700 px-4 py-3 rounded mb-6">
            Modifications enregistr√©es ! Le site sera red√©ploy√© dans 2-3 minutes.
          </div>

          <form id="config-form" class="space-y-6">
            <!-- SECTION PAR D√âFAUT -->
            <div class="border-2 border-primary-500 rounded-lg p-6 bg-primary-50">
              <h3 class="text-xl font-bold text-primary-900 mb-4 flex items-center gap-2">
                <span>‚≠ê</span> Contact par D√©faut (tous les d√©partements)
              </h3>

              <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                  <label
                    for="default-phone"
                    class="block text-sm font-medium text-gray-700 mb-2"
                  >
                    Num√©ro de t√©l√©phone par d√©faut
                  </label>
                  <input
                    type="text"
                    id="default-phone"
                    value={defaultContact.phoneDisplay}
                    class="phone-input w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-primary-500 font-semibold"
                    placeholder="07.56.97.44.93"
                  />
                  <p class="text-xs text-gray-500 mt-1">Format : 07.56.97.44.93</p>
                </div>

                <div>
                  <label
                    for="default-email"
                    class="block text-sm font-medium text-gray-700 mb-2"
                  >
                    Email par d√©faut
                  </label>
                  <input
                    type="email"
                    id="default-email"
                    value={defaultContact.email}
                    class="email-input w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-primary-500 font-semibold"
                    placeholder="contact@eric-plomberie.fr"
                  />
                </div>
              </div>
            </div>

            <!-- D√âPARTEMENTS -->
            <div>
              <div class="flex items-center justify-between mb-6">
                <div>
                  <h3 class="text-xl font-bold text-gray-900">Surcharges par d√©partement (optionnel)</h3>
                  <p class="text-sm text-gray-600 mt-1">
                    Laissez vide pour utiliser les valeurs par d√©faut ci-dessus.
                  </p>
                </div>

                <div class="w-80">
                  <input
                    type="text"
                    id="dept-search"
                    placeholder="üîç Rechercher un d√©partement..."
                    class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-primary-500"
                  />
                </div>
              </div>

              <div id="dept-list" class="grid grid-cols-1 gap-6">
                {departements.map((dept) => {
                  const deptConfig = departementsConfigRaw[dept.code as keyof typeof departementsConfigRaw];
                  const hasPhoneOverride = deptConfig && 'phoneDisplay' in deptConfig;
                  const hasEmailOverride = deptConfig && 'email' in deptConfig;

                  return (
                    <div class="border border-gray-200 rounded-lg p-6 hover:shadow-md transition">
                      <h3 class="text-lg font-bold text-gray-900 mb-4">
                        {dept.code} - {dept.name}
                        {(hasPhoneOverride || hasEmailOverride) && (
                          <span class="ml-2 text-xs font-normal text-orange-600 bg-orange-100 px-2 py-1 rounded">
                            Personnalis√©
                          </span>
                        )}
                      </h3>

                      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                          <label
                            for={`phone-${dept.code}`}
                            class="block text-sm font-medium text-gray-700 mb-2"
                          >
                            Num√©ro de t√©l√©phone
                          </label>
                          <input
                            type="text"
                            id={`phone-${dept.code}`}
                            data-dept={dept.code}
                            data-field="phone"
                            value={hasPhoneOverride && 'phoneDisplay' in deptConfig ? deptConfig.phoneDisplay : ''}
                            class="phone-input w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-primary-500"
                            placeholder={`Par d√©faut : ${defaultContact.phoneDisplay}`}
                          />
                          <p class="text-xs text-gray-500 mt-1">Laissez vide pour utiliser le num√©ro par d√©faut</p>
                        </div>

                        <div>
                          <label
                            for={`email-${dept.code}`}
                            class="block text-sm font-medium text-gray-700 mb-2"
                          >
                            Email
                          </label>
                          <input
                            type="email"
                            id={`email-${dept.code}`}
                            data-dept={dept.code}
                            data-field="email"
                            value={hasEmailOverride && 'email' in deptConfig ? deptConfig.email : ''}
                            class="email-input w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-primary-500"
                            placeholder={`Par d√©faut : ${defaultContact.email}`}
                          />
                          <p class="text-xs text-gray-500 mt-1">Laissez vide pour utiliser l'email par d√©faut</p>
                        </div>
                      </div>
                    </div>
                  );
                })}
              </div>
            </div>
            </div>

            <div class="flex gap-4 pt-6 border-t border-gray-200">
              <button
                type="button"
                id="validate-btn"
                class="bg-primary-600 text-white px-8 py-3 rounded-lg font-semibold hover:bg-primary-700 transition disabled:opacity-50 disabled:cursor-not-allowed"
              >
                ‚úÖ Valider les Modifications
              </button>

              <a
                href="/"
                class="bg-gray-200 text-gray-700 px-8 py-3 rounded-lg font-semibold hover:bg-gray-300 transition inline-block"
              >
                Retour au site
              </a>
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>

  <script define:vars={{ departements, defaultContact }}>
    const PASSWORD = 'artisanplombier';
    const SESSION_DURATION = 10 * 60 * 1000; // 10 minutes en millisecondes

    // Fonction pour v√©rifier si la session est valide
    function isSessionValid() {
      const sessionTime = localStorage.getItem('admin-session-time');
      if (!sessionTime) return false;

      const now = Date.now();
      const elapsed = now - parseInt(sessionTime, 10);
      return elapsed < SESSION_DURATION;
    }

    // Fonction pour cr√©er une session
    function createSession() {
      localStorage.setItem('admin-session-time', Date.now().toString());
    }

    // Fonction pour se connecter
    function login() {
      const loginForm = document.getElementById('login-form');
      const adminPanel = document.getElementById('admin-panel');

      loginForm?.classList.add('hidden');
      adminPanel?.classList.remove('hidden');
      createSession();
    }

    // V√©rifier la session au chargement de la page
    if (isSessionValid()) {
      console.log('‚úÖ Session valide - Auto-connexion');
      login();
    } else {
      console.log('‚ùå Session expir√©e ou inexistante - Affichage du formulaire de connexion');
      localStorage.removeItem('admin-session-time');
    }

    // Authentification
    document.getElementById('login-btn')?.addEventListener('click', () => {
      const passwordInput = document.getElementById('password');
      const errorMessage = document.getElementById('error-message');

      if (passwordInput.value === PASSWORD) {
        login();
        errorMessage?.classList.add('hidden');
      } else {
        errorMessage?.classList.remove('hidden');
      }
    });

    // Permettre la connexion avec Enter
    document.getElementById('password')?.addEventListener('keypress', (e) => {
      if (e.key === 'Enter') {
        document.getElementById('login-btn')?.click();
      }
    });

    // D√©connexion
    document.getElementById('logout-btn')?.addEventListener('click', () => {
      localStorage.removeItem('admin-session-time');
      location.reload();
    });

    // Mise √† jour du timer de session
    function updateSessionTimer() {
      const sessionTime = localStorage.getItem('admin-session-time');
      if (!sessionTime) return;

      const now = Date.now();
      const elapsed = now - parseInt(sessionTime, 10);
      const remaining = SESSION_DURATION - elapsed;

      if (remaining <= 0) {
        // Session expir√©e
        localStorage.removeItem('admin-session-time');
        alert('‚è∞ Session expir√©e\n\nVous allez √™tre d√©connect√©.');
        location.reload();
        return;
      }

      // Convertir en minutes:secondes
      const minutes = Math.floor(remaining / 60000);
      const seconds = Math.floor((remaining % 60000) / 1000);
      const timeText = `${minutes}:${seconds.toString().padStart(2, '0')}`;

      const sessionTimeElement = document.getElementById('session-time');
      if (sessionTimeElement) {
        sessionTimeElement.textContent = timeText;

        // Changer la couleur si < 2 minutes
        if (remaining < 2 * 60 * 1000) {
          sessionTimeElement.classList.add('text-red-600');
          sessionTimeElement.classList.remove('text-primary-600');
        } else {
          sessionTimeElement.classList.add('text-primary-600');
          sessionTimeElement.classList.remove('text-red-600');
        }
      }
    }

    // Mettre √† jour le timer toutes les secondes
    setInterval(updateSessionTimer, 1000);
    updateSessionTimer(); // Mise √† jour imm√©diate

    // Recherche de d√©partements
    document.getElementById('dept-search')?.addEventListener('input', (e) => {
      const searchTerm = e.target.value.toLowerCase();
      const deptCards = document.querySelectorAll('#dept-list > div');

      deptCards.forEach(card => {
        const deptText = card.textContent.toLowerCase();
        if (deptText.includes(searchTerm)) {
          card.style.display = 'block';
        } else {
          card.style.display = 'none';
        }
      });
    });

    // Valider les modifications
    document.getElementById('validate-btn')?.addEventListener('click', async () => {
      console.log('üîµ Bouton Valider cliqu√©');

      const validateBtn = document.getElementById('validate-btn');
      const successMessage = document.getElementById('success-message');
      const errorMessage = document.getElementById('error-message');

      // D√©sactiver le bouton pendant le traitement
      validateBtn.disabled = true;
      validateBtn.textContent = '‚è≥ Enregistrement en cours...';

      const config = {};

      // R√©cup√©rer les valeurs par d√©faut
      const defaultPhoneInput = document.getElementById('default-phone');
      const defaultEmailInput = document.getElementById('default-email');

      const defaultPhoneDisplay = defaultPhoneInput.value;
      const defaultPhoneClean = defaultPhoneDisplay.replace(/\s/g, '').replace(/\./g, '');

      config['default'] = {
        phone: defaultPhoneClean,
        phoneDisplay: defaultPhoneDisplay,
        email: defaultEmailInput.value
      };

      console.log('üìù Valeurs par d√©faut:', config['default']);

      // R√©cup√©rer les surcharges par d√©partement
      departements.forEach(dept => {
        const phoneInput = document.getElementById(`phone-${dept.code}`);
        const emailInput = document.getElementById(`email-${dept.code}`);

        if (phoneInput && emailInput) {
          const phoneDisplay = phoneInput.value.trim();
          const email = emailInput.value.trim();

          // Cr√©er la config du d√©partement (toujours avec le nom)
          const deptConfig = {
            name: dept.name
          };

          // N'ajouter phone/email que s'ils diff√®rent du d√©faut
          if (phoneDisplay && phoneDisplay !== defaultPhoneDisplay) {
            const phoneClean = phoneDisplay.replace(/\s/g, '').replace(/\./g, '');
            deptConfig.phone = phoneClean;
            deptConfig.phoneDisplay = phoneDisplay;
            console.log(`üìû Surcharge t√©l√©phone pour ${dept.code}:`, phoneDisplay);
          }

          if (email && email !== defaultEmailInput.value) {
            deptConfig.email = email;
            console.log(`üìß Surcharge email pour ${dept.code}:`, email);
          }

          config[dept.code] = deptConfig;
        }
      });

      console.log('üì¶ Configuration compl√®te:', config);

      try {
        console.log('üöÄ Envoi de la requ√™te API...');

        // Appeler l'API pour enregistrer les modifications
        const response = await fetch('/api/update-contacts', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            password: PASSWORD,
            contacts: config
          })
        });

        console.log('üì° R√©ponse API re√ßue, status:', response.status);

        const result = await response.json();
        console.log('üìÑ R√©sultat:', result);

        if (response.ok) {
          // Afficher le message de succ√®s
          const message = result.message || 'Modifications enregistr√©es! Le site sera red√©ploy√© dans 2-3 minutes.';
          console.log('‚úÖ Succ√®s:', message);

          // Renouveler la session
          createSession();
          updateSessionTimer();

          // Afficher une alerte de confirmation
          alert('‚úÖ Succ√®s!\n\n' + message);

          if (successMessage) {
            successMessage.textContent = message;
            successMessage.classList.remove('hidden');
            // Garder le message visible plus longtemps
            setTimeout(() => {
              successMessage.classList.add('hidden');
            }, 15000);
          }
        } else {
          // Afficher le message d'erreur
          const errMsg = result.error || 'Erreur lors de l\'enregistrement';
          console.error('‚ùå Erreur:', errMsg);

          // Afficher une alerte d'erreur
          alert('‚ùå Erreur!\n\n' + errMsg + '\n\nV√©rifiez la console pour plus de d√©tails.');

          if (errorMessage) {
            errorMessage.textContent = errMsg;
            errorMessage.classList.remove('hidden');
            // Ne pas masquer automatiquement les erreurs
          }
        }
      } catch (error) {
        // Erreur r√©seau
        console.error('üí• Erreur de connexion:', error);

        const errMsg = 'Erreur de connexion: ' + error.message;
        alert('‚ùå Erreur de connexion!\n\n' + errMsg + '\n\nV√©rifiez votre connexion internet et la console.');

        if (errorMessage) {
          errorMessage.textContent = errMsg;
          errorMessage.classList.remove('hidden');
          // Ne pas masquer automatiquement les erreurs
        }
      } finally {
        // R√©activer le bouton
        validateBtn.disabled = false;
        validateBtn.textContent = '‚úÖ Valider les Modifications';
        console.log('üèÅ Validation termin√©e');
      }
    });
  </script>
</BaseLayout>
