---
import BaseLayout from '../layouts/BaseLayout.astro';
import { getAllDepartements } from '../utils/departement-contact';

const departements = getAllDepartements();

const title = "Administration - Eric Plomberie";
const description = "Interface d'administration pour g√©rer les contacts par d√©partement";
---

<BaseLayout title={title} description={description}>
  <div class="min-h-screen bg-gray-100 py-12 px-4">
    <div class="max-w-6xl mx-auto">
      <h1 class="text-4xl font-bold text-gray-900 mb-8">Administration Eric Plomberie</h1>

      <div id="login-form" class="bg-white rounded-lg shadow-md p-8 max-w-md mx-auto">
        <h2 class="text-2xl font-bold mb-6">Connexion</h2>

        <div id="error-message" class="hidden bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded mb-4">
          Mot de passe incorrect
        </div>

        <div class="space-y-4">
          <div>
            <label for="password" class="block text-sm font-medium text-gray-700 mb-2">
              Mot de passe
            </label>
            <input
              type="password"
              id="password"
              class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-primary-500"
              placeholder="Entrez le mot de passe"
            />
          </div>

          <button
            id="login-btn"
            class="w-full bg-primary-600 text-white px-6 py-3 rounded-lg font-semibold hover:bg-primary-700 transition"
          >
            Se connecter
          </button>
        </div>
      </div>

      <div id="admin-panel" class="hidden">
        <div class="bg-white rounded-lg shadow-md p-8">
          <h2 class="text-2xl font-bold mb-6">Gestion des contacts par d√©partement</h2>

          <div id="success-message" class="hidden bg-green-100 border border-green-400 text-green-700 px-4 py-3 rounded mb-6">
            Configuration t√©l√©charg√©e avec succ√®s !
          </div>

          <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-6">
            <p class="text-sm text-blue-800">
              <strong>‚ö†Ô∏è Important :</strong> Apr√®s avoir t√©l√©charg√© le fichier JSON :
            </p>
            <ol class="list-decimal list-inside text-sm text-blue-800 mt-2 space-y-1">
              <li>Remplacez le fichier <code class="bg-blue-100 px-1 rounded">src/data/departements-config.json</code></li>
              <li>Committez et d√©ployez le site sur Vercel</li>
              <li>Les changements seront appliqu√©s</li>
            </ol>
          </div>

          <form id="config-form" class="space-y-6">
            <div class="grid grid-cols-1 gap-6">
              {departements.map((dept) => (
                <div class="border border-gray-200 rounded-lg p-6 hover:shadow-md transition">
                  <h3 class="text-lg font-bold text-gray-900 mb-4">
                    {dept.code} - {dept.name}
                  </h3>

                  <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                      <label
                        for={`phone-${dept.code}`}
                        class="block text-sm font-medium text-gray-700 mb-2"
                      >
                        Num√©ro de t√©l√©phone
                      </label>
                      <input
                        type="text"
                        id={`phone-${dept.code}`}
                        data-dept={dept.code}
                        data-field="phone"
                        value={dept.phoneDisplay}
                        class="phone-input w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-primary-500"
                        placeholder="07.56.97.44.93"
                      />
                      <p class="text-xs text-gray-500 mt-1">Format : 07.56.97.44.93</p>
                    </div>

                    <div>
                      <label
                        for={`email-${dept.code}`}
                        class="block text-sm font-medium text-gray-700 mb-2"
                      >
                        Email
                      </label>
                      <input
                        type="email"
                        id={`email-${dept.code}`}
                        data-dept={dept.code}
                        data-field="email"
                        value={dept.email}
                        class="email-input w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-primary-500"
                        placeholder="contact@eric-plomberie.fr"
                      />
                    </div>
                  </div>
                </div>
              ))}
            </div>

            <div class="flex gap-4 pt-6 border-t border-gray-200">
              <button
                type="button"
                id="download-btn"
                class="bg-primary-600 text-white px-8 py-3 rounded-lg font-semibold hover:bg-primary-700 transition"
              >
                üì• T√©l√©charger la configuration (JSON)
              </button>

              <a
                href="/"
                class="bg-gray-200 text-gray-700 px-8 py-3 rounded-lg font-semibold hover:bg-gray-300 transition inline-block"
              >
                Retour au site
              </a>
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>

  <script define:vars={{ departements }}>
    const PASSWORD = 'artisanplombier';

    // Authentification
    document.getElementById('login-btn')?.addEventListener('click', () => {
      const passwordInput = document.getElementById('password');
      const errorMessage = document.getElementById('error-message');
      const loginForm = document.getElementById('login-form');
      const adminPanel = document.getElementById('admin-panel');

      if (passwordInput.value === PASSWORD) {
        loginForm?.classList.add('hidden');
        adminPanel?.classList.remove('hidden');
        errorMessage?.classList.add('hidden');
      } else {
        errorMessage?.classList.remove('hidden');
      }
    });

    // Permettre la connexion avec Enter
    document.getElementById('password')?.addEventListener('keypress', (e) => {
      if (e.key === 'Enter') {
        document.getElementById('login-btn')?.click();
      }
    });

    // T√©l√©charger la configuration
    document.getElementById('download-btn')?.addEventListener('click', () => {
      const config = {};

      // R√©cup√©rer toutes les valeurs des inputs
      departements.forEach(dept => {
        const phoneInput = document.getElementById(`phone-${dept.code}`);
        const emailInput = document.getElementById(`email-${dept.code}`);

        if (phoneInput && emailInput) {
          const phoneDisplay = phoneInput.value;
          const phoneClean = phoneDisplay.replace(/\s/g, '').replace(/\./g, '');

          config[dept.code] = {
            name: dept.name,
            phone: phoneClean,
            phoneDisplay: phoneDisplay,
            email: emailInput.value
          };
        }
      });

      // Cr√©er le fichier JSON
      const jsonStr = JSON.stringify(config, null, 2);
      const blob = new Blob([jsonStr], { type: 'application/json' });
      const url = URL.createObjectURL(blob);

      // T√©l√©charger le fichier
      const a = document.createElement('a');
      a.href = url;
      a.download = 'departements-config.json';
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);

      // Afficher le message de succ√®s
      const successMessage = document.getElementById('success-message');
      successMessage?.classList.remove('hidden');
      setTimeout(() => {
        successMessage?.classList.add('hidden');
      }, 5000);
    });
  </script>
</BaseLayout>
