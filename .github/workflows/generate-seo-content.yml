name: G√©n√©ration de Contenu SEO Automatique

on:
  schedule:
    # 3 fois par jour : 8h (matin), 12h (midi), 18h (soir) UTC
    - cron: '0 7 * * *'   # 8h Paris (7h UTC)
    - cron: '0 11 * * *'  # 12h Paris (11h UTC)
    - cron: '0 17 * * *'  # 18h Paris (17h UTC)

  workflow_dispatch: # Permet de lancer manuellement
    inputs:
      articles_count:
        description: 'Nombre d\'articles √† g√©n√©rer'
        required: false
        default: '50'
      time_slot:
        description: 'Time slot (morning/noon/evening)'
        required: false
        default: 'morning'

jobs:
  generate-content:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm install

      - name: Install Anthropic SDK
        run: npm install @anthropic-ai/sdk

      - name: D√©terminer le time slot
        id: timeslot
        run: |
          HOUR=$(date +%H)
          if [ $HOUR -ge 6 ] && [ $HOUR -lt 11 ]; then
            echo "slot=morning" >> $GITHUB_OUTPUT
          elif [ $HOUR -ge 11 ] && [ $HOUR -lt 16 ]; then
            echo "slot=noon" >> $GITHUB_OUTPUT
          else
            echo "slot=evening" >> $GITHUB_OUTPUT
          fi

      - name: G√©n√©rer le contenu SEO
        env:
          CLAUDE_API_KEY: ${{ secrets.CLAUDE_API_KEY }}
          ARTICLES_PER_RUN: ${{ github.event.inputs.articles_count || '50' }}
          TIME_SLOT: ${{ github.event.inputs.time_slot || steps.timeslot.outputs.slot }}
        run: node scripts/generate-seo-content.mjs

      - name: Commit et push les nouveaux articles
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add src/data/blog/
          git diff --quiet && git diff --staged --quiet || (git commit -m "ü§ñ G√©n√©ration automatique de contenu SEO - ${{ steps.timeslot.outputs.slot }}" && git push)

      - name: Trigger Vercel redeploy (optionnel)
        if: success()
        run: |
          # Optionnel: d√©clencher un redeploy Vercel via webhook
          # curl -X POST ${{ secrets.VERCEL_DEPLOY_HOOK }}
          echo "Articles g√©n√©r√©s avec succ√®s. Vercel rebuild automatique au prochain commit."

      - name: Notification de succ√®s
        if: success()
        run: |
          echo "‚úÖ G√©n√©ration de contenu SEO r√©ussie - ${{ steps.timeslot.outputs.slot }}"

      - name: Notification d'erreur
        if: failure()
        run: |
          echo "‚ùå Erreur lors de la g√©n√©ration de contenu SEO"
